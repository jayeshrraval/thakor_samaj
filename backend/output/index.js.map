{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": "output",
  "sourcesContent": ["/**\n * Yogi Samaj Sambandh Backend Worker\n * Handles family registration and search APIs\n */\n\ninterface Env {\n  DB: D1Database;\n}\n\ninterface FamilyMember {\n  member_name: string;\n  relationship: string;\n  gender: string;\n}\n\ninterface FamilyData {\n  head_name: string;\n  sub_surname: string;\n  gol: string;\n  village?: string;\n  taluko?: string;\n  district?: string;\n  current_residence?: string;\n  members: FamilyMember[];\n}\n\n// CORS headers\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Encrypted-Yw-ID, X-Is-Login',\n};\n\nexport default {\n  async fetch(request: Request, env: Env): Promise<Response> {\n    // Handle CORS preflight\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    const url = new URL(request.url);\n    const path = url.pathname;\n\n    try {\n      // Get user ID from header\n      const encryptedYwId = request.headers.get('X-Encrypted-Yw-ID') || 'anonymous';\n\n      // API Routes\n      if (path === '/api/families' && request.method === 'POST') {\n        return await createFamily(request, env, encryptedYwId);\n      }\n\n      if (path === '/api/families' && request.method === 'GET') {\n        return await getFamilies(request, env);\n      }\n\n      if (path.match(/^\\/api\\/families\\/\\d+$/) && request.method === 'GET') {\n        const id = path.split('/').pop();\n        return await getFamilyById(env, parseInt(id!));\n      }\n\n      if (path === '/api/families/search' && request.method === 'GET') {\n        return await searchFamilies(request, env);\n      }\n\n      // 404 for unknown routes\n      return new Response(JSON.stringify({ error: 'Not found' }), {\n        status: 404,\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      });\n    } catch (error) {\n      console.error('API Error:', error);\n      return new Response(\n        JSON.stringify({ error: error instanceof Error ? error.message : 'Internal server error' }),\n        {\n          status: 500,\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        }\n      );\n    }\n  },\n};\n\n// Create a new family registration\nasync function createFamily(request: Request, env: Env, encryptedYwId: string): Promise<Response> {\n  const data: FamilyData = await request.json();\n\n  // Validation\n  if (!data.head_name || !data.sub_surname || !data.gol) {\n    return new Response(\n      JSON.stringify({ error: '\u0AAE\u0ACB\u0AAD\u0AC0\u0AA8\u0AC1\u0A82 \u0AA8\u0ABE\u0AAE, \u0AAA\u0AC7\u0A9F\u0ABE \u0A85\u0A9F\u0A95 \u0A85\u0AA8\u0AC7 \u0A97\u0ACB\u0AB3 \u0A9C\u0AB0\u0AC2\u0AB0\u0AC0 \u0A9B\u0AC7' }),\n      {\n        status: 400,\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      }\n    );\n  }\n\n  if (!data.members || data.members.length === 0) {\n    return new Response(\n      JSON.stringify({ error: '\u0A93\u0A9B\u0ABE\u0AAE\u0ABE\u0A82 \u0A93\u0A9B\u0ACB \u0A8F\u0A95 \u0AB8\u0AAD\u0ACD\u0AAF \u0A89\u0AAE\u0AC7\u0AB0\u0ACB' }),\n      {\n        status: 400,\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n      }\n    );\n  }\n\n  // Insert family\n  const familyStmt = env.DB.prepare(`\n    INSERT INTO families (head_name, sub_surname, gol, village, taluko, district, current_residence, encrypted_yw_id)\n    VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n  `);\n\n  const familyResult = await familyStmt\n    .bind(\n      data.head_name,\n      data.sub_surname,\n      data.gol,\n      data.village || null,\n      data.taluko || null,\n      data.district || null,\n      data.current_residence || null,\n      encryptedYwId\n    )\n    .run();\n\n  const familyId = familyResult.meta.last_row_id;\n\n  // Insert family members\n  for (const member of data.members) {\n    const memberStmt = env.DB.prepare(`\n      INSERT INTO family_members (family_id, member_name, relationship, gender)\n      VALUES (?, ?, ?, ?)\n    `);\n    await memberStmt.bind(familyId, member.member_name, member.relationship, member.gender).run();\n  }\n\n  return new Response(\n    JSON.stringify({\n      success: true,\n      message: '\u0AAA\u0AB0\u0ABF\u0AB5\u0ABE\u0AB0 \u0AB8\u0AAB\u0AB3\u0AA4\u0ABE\u0AAA\u0AC2\u0AB0\u0ACD\u0AB5\u0A95 \u0AB0\u0A9C\u0AC0\u0AB8\u0ACD\u0A9F\u0AB0 \u0AA5\u0AAF\u0ACB',\n      family_id: familyId,\n    }),\n    {\n      status: 201,\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n    }\n  );\n}\n\n// Get all families with pagination\nasync function getFamilies(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const limit = parseInt(url.searchParams.get('limit') || '20');\n  const offset = parseInt(url.searchParams.get('offset') || '0');\n\n  const { results } = await env.DB.prepare(`\n    SELECT * FROM families ORDER BY created_at DESC LIMIT ? OFFSET ?\n  `)\n    .bind(limit, offset)\n    .all();\n\n  // Get members for each family\n  const familiesWithMembers = await Promise.all(\n    results.map(async (family: any) => {\n      const { results: members } = await env.DB.prepare(`\n        SELECT * FROM family_members WHERE family_id = ?\n      `)\n        .bind(family.id)\n        .all();\n      return { ...family, members };\n    })\n  );\n\n  return new Response(JSON.stringify({ families: familiesWithMembers }), {\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n  });\n}\n\n// Get family by ID\nasync function getFamilyById(env: Env, id: number): Promise<Response> {\n  const { results: familyResults } = await env.DB.prepare(`\n    SELECT * FROM families WHERE id = ?\n  `)\n    .bind(id)\n    .all();\n\n  if (familyResults.length === 0) {\n    return new Response(JSON.stringify({ error: '\u0AAA\u0AB0\u0ABF\u0AB5\u0ABE\u0AB0 \u0AAE\u0AB3\u0ACD\u0AAF\u0ACB \u0AA8\u0AA5\u0AC0' }), {\n      status: 404,\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n    });\n  }\n\n  const family = familyResults[0];\n  const { results: members } = await env.DB.prepare(`\n    SELECT * FROM family_members WHERE family_id = ?\n  `)\n    .bind(id)\n    .all();\n\n  return new Response(JSON.stringify({ ...family, members }), {\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n  });\n}\n\n// Search families\nasync function searchFamilies(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const query = url.searchParams.get('q') || '';\n  const village = url.searchParams.get('village') || '';\n  const subSurname = url.searchParams.get('sub_surname') || '';\n  const gol = url.searchParams.get('gol') || '';\n\n  let sql = 'SELECT * FROM families WHERE 1=1';\n  const params: string[] = [];\n\n  if (query) {\n    sql += ' AND (head_name LIKE ? OR village LIKE ? OR sub_surname LIKE ? OR gol LIKE ?)';\n    const searchTerm = `%${query}%`;\n    params.push(searchTerm, searchTerm, searchTerm, searchTerm);\n  }\n\n  if (village) {\n    sql += ' AND village LIKE ?';\n    params.push(`%${village}%`);\n  }\n\n  if (subSurname) {\n    sql += ' AND sub_surname LIKE ?';\n    params.push(`%${subSurname}%`);\n  }\n\n  if (gol) {\n    sql += ' AND gol LIKE ?';\n    params.push(`%${gol}%`);\n  }\n\n  sql += ' ORDER BY created_at DESC LIMIT 50';\n\n  const stmt = env.DB.prepare(sql);\n  const { results } = await (params.length > 0 ? stmt.bind(...params) : stmt).all();\n\n  // Get members for each family\n  const familiesWithMembers = await Promise.all(\n    results.map(async (family: any) => {\n      const { results: members } = await env.DB.prepare(`\n        SELECT * FROM family_members WHERE family_id = ?\n      `)\n        .bind(family.id)\n        .all();\n      return { ...family, members };\n    })\n  );\n\n  return new Response(JSON.stringify({ families: familiesWithMembers }), {\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n  });\n}\n"],
  "mappings": "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",
  "names": []
}
